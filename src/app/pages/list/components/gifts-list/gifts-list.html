<section class="mt-8">
  <div class="mb-4 flex items-center justify-between gap-3">
    <h2 class="text-3xl font-christmas text-gold-gradient drop-shadow-lg">Cadeaux</h2>
    <app-christmas-button variant="primary" size="sm" [pressed]="fillMode()" (click)="toggleFillMode.emit()">
      {{ fillMode() ? 'Quitter le mode remplissage' : 'Passer en mode remplissage' }}
    </app-christmas-button>
  </div>
  @if (fillMode()) {
  <p
    class="mb-4 text-sm text-green-300 font-bold bg-black/40 p-3 rounded-lg border border-green-900/50 backdrop-blur-sm flex items-center gap-2">
    <span class="material-symbols-outlined text-green-400">info</span>
    Mode remplissage actif : coche un cadeau pour indiquer qu’il est déjà acheté.
  </p>
  } @else if (gifts().length > 1) {
  <p class="mb-3 text-xs text-white/50 italic text-right">Astuce : déplace les cadeaux pour les réorganiser.</p>
  }

  <ul class="card-glass flex flex-col divide-y divide-white/10 overflow-hidden" role="list">
    @for (g of gifts(); track g.id; let i = $index) {
    <li class="px-4 py-3 transition-colors hover:bg-white/5" (dragover)="onDragOver($event, i)" (drop)="onDrop(i)"
      [class.bg-white/10]="isDragging(i)" [class.ring-inset]="isDropTarget(i)" [class.ring-2]="isDropTarget(i)"
      [class.ring-gold-400]="isDropTarget(i)" role="listitem">
      @if (!fillMode() && editingId() === g.id) {
      <form class="flex flex-col gap-3 py-1" (ngSubmit)="submitEdit.emit()">
        <div>
          <label [for]="'edit-title-' + g.id" class="block text-xs font-bold text-gold-400 mb-1">Titre</label>
          <input [id]="'edit-title-' + g.id" type="text" class="input-base py-1" [formControl]="editTitleControl()!"
            placeholder="Titre du cadeau" [attr.aria-invalid]="editTitleInvalid() ? 'true' : null"
            [disabled]="editSubmitting() || isUpdating()(g.id!)" />
        </div>
        <div>
          <label [for]="'edit-url-' + g.id" class="block text-xs font-bold text-gold-400 mb-1">Lien (optionnel)</label>
          <input [id]="'edit-url-' + g.id" type="url" class="input-base py-1" [formControl]="editUrlControl()!"
            placeholder="https://exemple.com/produit" inputmode="url"
            [disabled]="editSubmitting() || isUpdating()(g.id!)" />
        </div>
        <div class="flex items-center gap-2 justify-end mt-1">
          <button type="button" class="btn-secondary btn-sm" (click)="cancelEdit.emit()">
            Annuler
          </button>
          <button type="submit" class="btn-primary btn-sm rounded-md"
            [disabled]="editSubmitting() || editTitleInvalid() || isUpdating()(g.id!)"
            [attr.aria-label]="'Enregistrer les modifications pour ' + g.title">
            Enregistrer
          </button>
        </div>
      </form>
      @if (editError()) {
      <p class="mt-2 text-sm text-red-400" role="alert">{{ editError() }}</p>
      }
      } @else {
      <div class="flex items-center justify-between gap-3">
        <div class="flex min-w-0 items-center gap-3">
          <button type="button"
            class="inline-flex size-8 shrink-0 cursor-grab items-center justify-center rounded-md text-white/30 hover:text-white/80 hover:bg-white/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gold-400 disabled:opacity-50 transition-colors"
            [attr.aria-label]="'Déplacer ' + g.title" [disabled]="fillMode() || !!editingId() || isUpdating()(g.id!)"
            [attr.draggable]="!fillMode() && !editingId() ? 'true' : null" (dragstart)="onDragStart(i, $event)"
            (dragend)="onDragEnd()" [class.cursor-grabbing]="isDragging(i)"
            [attr.aria-grabbed]="isDragging(i) ? 'true' : null">
            <span aria-hidden="true" class="material-symbols-outlined">drag_indicator</span>
          </button>
          <div class="min-w-0 flex flex-col">
            @if (g.url) {
            <a class="truncate font-bold text-base text-gold-gradient underline decoration-gold-400/50 decoration-2 underline-offset-4 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gold-400"
              [href]="g.url" target="_blank" rel="noopener noreferrer">
              {{ g.title }}
            </a>
            } @else {
            <p class="truncate font-bold text-base text-white">{{ g.title }}</p>
            }
            @if (fillMode() && g.bought) {
            <p class="text-[0.65rem] font-bold text-green-400 flex items-center gap-1 mt-0.5 uppercase tracking-wide">
              <span class="material-symbols-outlined text-sm">check_circle</span>
              Déjà acheté
            </p>
            }
          </div>
        </div>
        @if (fillMode()) {
        <div class="flex items-center gap-2">
          <div class="relative flex items-center">
            <input type="checkbox"
              class="peer size-6 appearance-none rounded-md border-2 border-white/30 bg-black/20 checked:bg-green-500 checked:border-green-500 focus:outline-none focus:ring-2 focus:ring-green-400 cursor-pointer transition-all"
              [checked]="!!g.bought" (change)="toggleBought.emit(g)" [disabled]="isUpdating()(g.id!)"
              [attr.aria-label]="'Marquer ' + g.title + ' comme acheté'" />
            <span
              class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 peer-checked:opacity-100 material-symbols-outlined text-xl">check</span>
          </div>
        </div>
        } @else {
        <div class="flex items-center gap-2">
          @if (deletingId() === g.id) {
          <button type="button"
            class="rounded-md inline-flex size-8 items-center justify-center bg-green-500/20 text-green-400 hover:bg-green-500/40 border border-green-500/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-green-400 disabled:opacity-60 transition-all backdrop-blur-md"
            (click)="confirmDelete.emit()" [disabled]="isUpdating()(g.id!)"
            [attr.aria-label]="'Confirmer la suppression de ' + g.title" title="Confirmer">
            <span class="material-symbols-outlined text-lg" aria-hidden="true">check</span>
          </button>
          <button type="button"
            class="inline-flex size-8 items-center justify-center rounded-md bg-red-500/20 text-red-400 hover:bg-red-500/40 border border-red-500/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 disabled:opacity-60 transition-all backdrop-blur-md"
            (click)="cancelDelete.emit()" [disabled]="isUpdating()(g.id!)"
            [attr.aria-label]="'Annuler la suppression de ' + g.title" title="Annuler">
            <span class="material-symbols-outlined text-lg" aria-hidden="true">close</span>
          </button>
          } @else {
          <button type="button"
            class="inline-flex size-8 items-center justify-center rounded-md text-white/40 hover:bg-white/10 hover:text-white/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 disabled:opacity-60 transition-colors"
            (click)="startEdit.emit(g)" [disabled]="isUpdating()(g.id!)" [attr.aria-label]="'Modifier ' + g.title">
            <span class="material-symbols-outlined text-xl" aria-hidden="true">edit</span>
          </button>
          <button type="button"
            class="inline-flex size-8 items-center justify-center rounded-md text-white/40 hover:text-red-400 hover:bg-red-500/10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 disabled:opacity-60 transition-colors"
            (click)="startDelete.emit(g)" [disabled]="isUpdating()(g.id!) || !!editingId()"
            [attr.aria-label]="'Supprimer ' + g.title">
            <span class="material-symbols-outlined text-xl" aria-hidden="true">delete</span>
          </button>
          }
        </div>
        }
      </div>
      }
    </li>
    } @empty {
    <li class="px-4 py-12 text-center text-white/50 italic">
      <span class="block text-4xl mb-3 opacity-50">✨</span>
      Ta liste est vide pour le moment.<br />Ajoute ton premier souhait ci-dessous.
    </li>
    }
  </ul>
</section>
